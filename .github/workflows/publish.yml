name: Inspect npm OIDC Flow
on: workflow_dispatch

jobs:
  inspect:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      # claude wrote this
      - name: Inspect OIDC tokens
        run: |
          PACKAGE_NAME="@bakkot/npm-poking"
          REGISTRY="https://registry.npmjs.org"

          echo "=== OIDC Request Credentials (used to GET the JWT) ==="
          echo "ACTIONS_ID_TOKEN_REQUEST_URL: $ACTIONS_ID_TOKEN_REQUEST_URL"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN: $ACTIONS_ID_TOKEN_REQUEST_TOKEN"
          echo ""

          # Audience format is npm:<hostname>
          AUDIENCE="npm:registry.npmjs.org"

          echo "=== Requesting GitHub OIDC JWT with audience: $AUDIENCE ==="
          OIDC_RESPONSE=$(curl -s -H "Accept: application/json" \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUDIENCE}")

          echo "Raw response:"
          echo "$OIDC_RESPONSE" | jq .

          OIDC_TOKEN=$(echo "$OIDC_RESPONSE" | jq -r '.value')

          echo ""
          echo "=== GitHub OIDC JWT ==="
          echo "$OIDC_TOKEN"

          echo ""
          echo "=== Decoded JWT Header ==="
          echo "$OIDC_TOKEN" | cut -d'.' -f1 | base64 -d 2>/dev/null | jq .

          echo ""
          echo "=== Decoded JWT Payload ==="
          echo "$OIDC_TOKEN" | cut -d'.' -f2 | base64 -d 2>/dev/null | jq .

          echo ""
          echo "=== Exchanging for npm token ==="
          # Endpoint is /-/npm/v1/oidc/token/exchange/package/<escaped-package-name>
          # The OIDC token is sent as a Bearer token in the Authorization header
          ESCAPED_PACKAGE=$(echo "$PACKAGE_NAME" | sed 's/@/%40/g; s/\//%2f/g')
          EXCHANGE_URL="${REGISTRY}/-/npm/v1/oidc/token/exchange/package/${ESCAPED_PACKAGE}"

          echo "Exchange URL: $EXCHANGE_URL"
          echo ""

          NPM_TOKEN_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            "$EXCHANGE_URL")

          echo "npm token exchange response:"
          echo "$NPM_TOKEN_RESPONSE" | jq .

          echo ""
          echo "=== Extracted npm publish token ==="
          echo "$NPM_TOKEN_RESPONSE" | jq -r '.token // empty'

          # If there's an error, show it
          if echo "$NPM_TOKEN_RESPONSE" | jq -e '.error // .message' > /dev/null 2>&1; then
            echo ""
            echo "=== Error (expected if trusted publishing not configured) ==="
            echo "$NPM_TOKEN_RESPONSE" | jq -r '.error // .message // .'
          fi